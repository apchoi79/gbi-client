var Seed={};Seed.CORSProxyURL=null;Seed.Seeder=function(task,source,cache){this.task=task;this.source=source;this.cache=cache;this.currentLevel=null;this.currentAffectedTiles=null;this.running=false;this.should_stop=false;this.progressCb=null;this.seededTiles=0;this.totalTiles=this.task.grid.estimateTiles(this.task.bbox,this.task.levels);};Seed.Seeder.prototype={start:function(progress){this.currentLevel=this.task.levels[0];this.currentAffectedTiles=this.task.grid.affectedTiles(this.currentLevel,this.task.bbox);this.running=true;this.progressCb=progress;this.next();},stop:function(){this.should_stop=true;},next:function(){if(!this.running)return;if(this.should_stop){this.running=false;this.progress();return;}var tile=this.currentAffectedTiles.next();if(tile==null){this.currentLevel+=1;if(this.currentLevel>this.task.levels[1]){this.running=false;this.progress();return;}this.currentAffectedTiles=this.task.grid.affectedTiles(this.currentLevel,this.task.bbox);tile=this.currentAffectedTiles.next();}var seeder=this;function continueSeed(){var continueSeeding=seeder.progress();if(continueSeeding!=false)seeder.next();else{this.running=false;this.progress();}}this.source.fetchTile(tile,function(tile){if(seeder.cache!=undefined)seeder.cache.storeTile(tile,continueSeed);else continueSeed();});},progress:function(){if(this.running)this.seededTiles+=1;if(this.progressCb!=null)return this.progressCb({'tiles':this.seededTiles,'totalTiles':this.totalTiles,'running':this.running});else return true;}};Seed.Cache={};Seed.Cache.LocalStore=function(prefix){this.prefix=prefix;};Seed.Cache.LocalStore.prototype={storeTile:function(tile,success){console.log(tile);window.localStorage.setItem(this.prefix+tile.url,tile.data);success(tile);}};Seed.Cache.CouchDB=function(url){this.url=url;};Seed.Cache.CouchDB.prototype={storeTile:function(tile,success){var url=this.url;url=url.replace(/\{TileCol\}/,tile.coord[0]);url=url.replace(/\{TileRow\}/,tile.coord[1]);url=url.replace(/\{TileMatrix\}/,tile.coord[2]);var req=new XMLHttpRequest();req.open("PUT",url,true);req.onload=function(evt){success(tile);};var blob=new Blob([Seed.Util.dataURIToBlob(tile.data)],{type:'image/png'});req.send(blob);}};Seed.BBox=function(minx,miny,maxx,maxy){this.minx=minx;this.miny=miny;this.maxx=maxx;this.maxy=maxy;};Seed.BBox.prototype={size:function(){return [this.maxx-this.miny,this.maxy-this.miny];}};Seed.DefaultBBox=new Seed.BBox(-20037508.342789244,-20037508.342789244,20037508.342789244,20037508.342789244);Seed.Grid=function(){this.resolutions=[];this.tileSize=[256,256];this.bbox=Seed.DefaultBBox;var res=this.bbox.size()[0]/256;for(var i=0;i<20;i++){this.resolutions.push(res);res=res/2.0;};};Seed.Grid.prototype={tileBBox:function(x,y,z){var res=this.resolutions[z];var x0=this.bbox.minx+(x*res*this.tileSize[0]);var x1=x0+(res*this.tileSize[0]);var y1=this.bbox.maxy-(y*res*this.tileSize[1]);var y0=y1-(res*this.tileSize[1]);return new Seed.BBox(x0,y0,x1,y1);},tile:function(x,y,level){var res=this.resolutions[level];x=x-this.bbox.minx;y=this.bbox.maxy-y;var tileX=x/(res*this.tileSize[0]);var tileY=y/(res*this.tileSize[1]);return [Math.floor(tileX),Math.floor(tileY),level];},affectedTiles:function(level,bbox){if(bbox==undefined)bbox=this.bbox;var delta=this.resolutions[level]/10.0;ul=this.tile(bbox.minx+delta,bbox.maxy-delta,level);lr=this.tile(bbox.maxx-delta,bbox.miny+delta,level);return new Seed.TileIter(ul[0],ul[1],lr[0],lr[1],level);},estimateTiles:function(bbox,levels){var tiles=0;for(var level=levels[0];level<=levels[1];level++){var affected=this.affectedTiles(level,bbox);tiles+=affected.numTiles[0]*affected.numTiles[1];};return tiles;}};Seed.TileIter=function(x0,y0,x1,y1,level){this.x0=x0;this.y0=y0;this.x1=x1;this.y1=y1;this.level=level;this.numTiles=[x1-x0+1,y1-y0+1];this.currentX=x0-1;this.currentY=y0;};Seed.TileIter.prototype={next:function(){this.currentX+=1;if(this.currentX>this.x1){this.currentX=this.x0;this.currentY+=1;}if(this.currentY>this.y1)return null;return [this.currentX,this.currentY,this.level];},foreach:function(func){for(var tile=this.next();tile!==null;tile=this.next())func(tile);}};Seed.Source={};Seed.Source.WMTSSource=function(url){this.url=url;};Seed.Source.WMTSSource.prototype={fetchTile:function(tile,success){var url=this.url;url=url.replace(/\{TileCol\}/,tile[0]);url=url.replace(/\{TileRow\}/,tile[1]);url=url.replace(/\{TileMatrix\}/,tile[2]);Seed.Util.fetchTileURL(url,tile,success);}};Seed.Source.WMSSource=function(url){this.url=url;this.grid=new Seed.Grid();};Seed.Source.WMSSource.prototype={fetchTile:function(tile,success){var bbox=this.grid.tileBBox(tile[0],tile[1],tile[2]);bbox=bbox.minx+","+bbox.miny+","+bbox.maxx+","+bbox.maxy;var url=this.url;url=url.replace(/\{BBOX\}/,bbox);Seed.Util.fetchTileURL(url,tile,success);}};Seed.Source.TestSource=function(url){this.url=url;this.fetchedTiles=[];};Seed.Source.TestSource.prototype={fetchTile:function(tile,success){this.fetchedTiles.push(tile);window.setTimeout(function(){success("fill in tile data here");},0);}};Seed.Util={};Seed.Util.base64ToBlob=function(base64){var binary=atob(base64);var len=binary.length;var buffer=new ArrayBuffer(len);var view=new Uint8Array(buffer);for(var i=0;i<len;i++)view[i]=binary.charCodeAt(i);return new Blob([view]);};Seed.Util.dataURIToBlob=function(dataURI){return Seed.Util.base64ToBlob(dataURI.replace(/^data:image\/(png|jpg);base64,/,""));};Seed.Util.imgToDataURI=function(img){var canvas=document.createElement("canvas");canvas.width=img.width;canvas.height=img.height;var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0);return canvas.toDataURL("image/png");};Seed.Util.fetchTileURL=function(url,tile,success){var img=new Image();if(url.match(/https?:\/\//)){img.crossOrigin="Anonymous";if(Seed.CORSProxyURL!=null)img.src=Seed.CORSProxyURL+url;else img.src=url;}else img.src=url;img.onload=function(){success({'url':url,'coord':tile,'data':Seed.Util.imgToDataURI(img)});};};