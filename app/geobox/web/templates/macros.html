{% macro generate_base_layer(layer) -%}
    {% if layer.view_level_end %}
    var numZoomLevels = {{ layer.view_level_end }} + 1;
    {% else %}
    var numZoomLevels = 18;
    {% endif %}

    var backgroundLayer = new gbi.Layers.WMTS({
        name: '{{ layer.title }}',
        url: '{{ layer.url }}',
        layer: '{{ layer.layer }}',
        format: '{{ layer.format }}',
        background: true,
        // isBaseLayer: true,
        {% if layer.bbox %}
        restrictedExtent: new OpenLayers.Bounds{{ layer.bbox }}
        {% endif %}
    });
{%- endmacro %}

{% macro generate_couch_layers(layers) -%}
    var couchLayers = [];
    {% for layer in layers %}
        couchLayers.push(new gbi.Layers.Couch({
            name: "{{layer.title}}",
            url: OpenlayersCouchURL,
            createDB: false,
            callbacks: {
                changes: function(unsavedChanges) {
                    if(unsavedChanges)
                        $('#save').removeAttr('disabled');
                    else
                        $('#save').attr('disabled', 'disabled');
                    }
            }
          })
        );
    {% endfor %}
{%- endmacro %}


{% macro generate_sources(sources, cache_url, coverages=True) -%}
    var raster_sources = {};
    {% for source in sources %}
        {% if source.wmts_source %}
          {% set map_source = source.wmts_source %}
          {% set layer_name = source.wmts_source.name %}
        {% else %}
           {% set map_source = source %}
           {% set layer_name = source.layer %}
        {% endif %}

        raster_sources[{{ source.id }}] = new gbi.Layers.WMTS({
            name: '{{ map_source.title }}',
            url: {% if source.url %} '{{add_auth_to_url(source.url, source.username, source.password)}}' {% else %} '{{ cache_url }}' {% endif %},
            layer: '{{ layer_name }}',
            format: '{{ map_source.format }}',
            source_id: {{ map_source.id }},
            download_level_start: {{ source.download_level_start }},
            download_level_end: {{ source.download_level_end }}
        });

        {% if coverages %}

        // add download coverage as vectorlayer
        raster_sources['{{ map_source.id }}_coverage'] = new gbi.Layers.Vector({
            name: '{{_('download coverage')}} {{ map_source.title }}',
            styleMap: downloadAreaStyleMap,
            displayInLayerSwitcher: true,
            source_id: {{ map_source.id }},
            editable: false,
            attributePopup: false
        });

        var geojson_format = new OpenLayers.Format.GeoJSON();
        {%if map_source.download_coverage %}
          var coverage = {{ map_source.download_coverage|tojson|safe }};
        {% else %}
          var coverage = {{ map_source.wmts_source.download_coverage|tojson|safe }};
        {% endif %}
        raster_sources['{{ map_source.id }}_coverage'].olLayer.addFeatures(geojson_format.read(coverage));
        {% endif %}
    {% endfor %}
{%- endmacro %}


{% macro generate_tooltip(content) -%}
    <span class="tooltip_element icon-info-sign" title="{{ content }}"></span>
{%- endmacro %}
